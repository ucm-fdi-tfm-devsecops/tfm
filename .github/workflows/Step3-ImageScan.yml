# # Reference from:
# https://www.aquasec.com/blog/devsecops-with-trivy-github-actions/

# Name of the security step
name: Step 3 - Image Scan

# Environment variables
env:
  IMAGE_NAME: tfm-app:latest
#  TRIVY_OUTPUT: 
#  TRIVY_SEVERITY:
#  TRIVY_VULN_TYPE: 

# When is it going to activate
on:
  # On demand
  workflow_call:
  # And when the father calls
  workflow_dispatch:

# Permissions
permissions:
  contents: read
  security-events: write

# What is going to do
jobs:
  # Name of the job
  trivy-scan:
    # Machine of GitHub - Microsoft where the job will be executed
    runs-on: ubuntu-latest
    steps:
      #  1. Download repo on the VM
      - name: Checkout repo
        uses: actions/checkout@v4
      #  2. Build docker
      - name: Build Docker image
        run: docker build -t ${{ env.IMAGE_NAME }} -f src/docker/Dockerfile .
      #  3. Scan the docker with trivy
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'image'
          image-ref: ${{ env.IMAGE_NAME }}
          format: 'sarif'
          output: 'imagescan-trivy-results.sarif'
          exit-code: 0
          vuln-type: 'os,library'
          severity: 'CRITICAL'
          scanners: 'vuln,misconfig'
      #  4. Export to Code Scanning Alerts
      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'imagescan-trivy-results.sarif'
